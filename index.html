import React, { useState, useEffect } from 'react';
import { 
  PlusCircle, 
  Trash2, 
  Calendar, 
  Image as ImageIcon,
  Send,
  Globe,
  Briefcase,
  Cpu,
  Palette,
  Upload,
  ArrowLeft,
  Home,
  MessageSquare,
  User
} from 'lucide-react';

export default function App() {
  // Datos iniciales de ejemplo (solo se usan si no hay nada guardado)
  const initialNews = [
    {
      id: 1,
      title: "Gran avance en energías renovables",
      category: "Tecnología",
      image: "https://images.unsplash.com/photo-1509391366360-2e959784a276?w=800&auto=format&fit=crop&q=60",
      content: "Científicos logran récord de eficiencia en paneles solares transparentes, lo que permitiría convertir ventanas de edificios en generadores de energía. Este desarrollo marca un hito en la búsqueda de soluciones sostenibles para las grandes urbes, donde el espacio para paneles tradicionales es limitado.\n\nEl equipo de investigación, liderado por la Universidad Nacional, asegura que la implementación comercial podría comenzar tan pronto como el próximo año.",
      author: "Redacción NTR",
      date: new Date().toLocaleDateString('es-MX', { year: 'numeric', month: 'long', day: 'numeric' }),
      comments: [
        { id: 101, author: "Carlos Ruiz", text: "¡Excelente noticia para el futuro del estado!", date: "Hace 2 horas" },
        { id: 102, author: "Ana López", text: "¿Se sabe cuándo llegarán a Zacatecas?", date: "Hace 1 hora" }
      ]
    },
    {
      id: 2,
      title: "Inauguración del Museo de Arte Moderno",
      category: "Arte",
      image: "https://images.unsplash.com/photo-1547891654-e66ed7ebb968?w=800&auto=format&fit=crop&q=60",
      content: "Miles de personas asistieron a la apertura de la nueva galería que exhibe obras contemporáneas de artistas locales e internacionales. La curaduría se centró en el diálogo entre la tradición zacatecana y las nuevas vanguardias digitales.\n\nEl gobernador del estado cortó el listón inaugural acompañado de figuras prominentes del ámbito cultural.",
      author: "Laura Martínez",
      date: new Date().toLocaleDateString('es-MX', { year: 'numeric', month: 'long', day: 'numeric' }),
      comments: []
    }
  ];

  // 1. CARGAR DATOS: Inicializamos el estado leyendo de localStorage
  const [articles, setArticles] = useState(() => {
    try {
      const savedData = localStorage.getItem('ntr_news_db');
      return savedData ? JSON.parse(savedData) : initialNews;
    } catch (error) {
      console.error("Error cargando datos:", error);
      return initialNews;
    }
  });

  // 2. GUARDAR DATOS: Cada vez que 'articles' cambie, guardamos en localStorage
  useEffect(() => {
    try {
      localStorage.setItem('ntr_news_db', JSON.stringify(articles));
    } catch (error) {
      console.error("Error guardando datos:", error);
    }
  }, [articles]);

  const [view, setView] = useState('home'); // 'home', 'create', 'article'
  const [selectedArticle, setSelectedArticle] = useState(null);
  
  // Form States (Noticia)
  const [title, setTitle] = useState('');
  const [content, setContent] = useState('');
  const [category, setCategory] = useState('General');
  const [image, setImage] = useState('');

  // Form States (Comentarios)
  const [commentName, setCommentName] = useState('');
  const [commentText, setCommentText] = useState('');
  
  // Estilos corporativos
  const ntrBlue = "bg-blue-900"; 
  const ntrText = "text-blue-900";

  const presetImages = [
    { name: "Tecnología", url: "https://images.unsplash.com/photo-1518770660439-4636190af475?w=800&auto=format&fit=crop&q=60", icon: <Cpu size={16} /> },
    { name: "Negocios", url: "https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?w=800&auto=format&fit=crop&q=60", icon: <Briefcase size={16} /> },
    { name: "Mundo", url: "https://images.unsplash.com/photo-1521295121783-8a321d551ad2?w=800&auto=format&fit=crop&q=60", icon: <Globe size={16} /> },
    { name: "Arte", url: "https://images.unsplash.com/photo-1513364776144-60967b0f800f?w=800&auto=format&fit=crop&q=60", icon: <Palette size={16} /> }
  ];

  // Manejo de imágenes
  const handleImageUpload = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => setImage(reader.result);
      reader.readAsDataURL(file);
    }
  };

  // Publicar noticia
  const handleSubmit = (e) => {
    e.preventDefault();
    if (!title || !content) return;
    const finalImage = image || "https://images.unsplash.com/photo-1585829365295-ab7cd400c167?w=800&auto=format&fit=crop&q=60";
    const newArticle = {
      id: Date.now(),
      title,
      category,
      image: finalImage,
      content,
      author: "Redacción NTR",
      date: new Date().toLocaleDateString('es-MX', { year: 'numeric', month: 'long', day: 'numeric' }),
      comments: [] // Inicializar array de comentarios vacío
    };
    setArticles([newArticle, ...articles]);
    resetForm();
    setView('home');
  };

  // Publicar comentario
  const handleAddComment = (e) => {
    e.preventDefault();
    if (!commentName.trim() || !commentText.trim()) return;

    const newComment = {
      id: Date.now(),
      author: commentName,
      text: commentText,
      date: new Date().toLocaleDateString('es-MX', { hour: '2-digit', minute: '2-digit' })
    };

    // Actualizar la lista general de artículos
    const updatedArticles = articles.map(art => {
      if (art.id === selectedArticle.id) {
        return {
          ...art,
          comments: [...(art.comments || []), newComment]
        };
      }
      return art;
    });

    setArticles(updatedArticles);

    // Actualizar también la noticia seleccionada actualmente para que se vea al instante
    setSelectedArticle({
      ...selectedArticle,
      comments: [...(selectedArticle.comments || []), newComment]
    });

    // Limpiar formulario de comentarios
    setCommentName('');
    setCommentText('');
  };

  const resetForm = () => {
    setTitle('');
    setContent('');
    setImage('');
    setCategory('General');
  };

  const handleDelete = (e, id) => {
    e.stopPropagation();
    if(window.confirm("¿Seguro que quieres borrar esta noticia?")) {
      setArticles(articles.filter(a => a.id !== id));
      if (selectedArticle?.id === id) {
        setView('home');
        setSelectedArticle(null);
      }
    }
  };

  const openArticle = (article) => {
    // Asegurarse de que comments exista si es antiguo
    const articleSafe = { ...article, comments: article.comments || [] };
    setSelectedArticle(articleSafe);
    setView('article');
    window.scrollTo(0, 0);
  };

  return (
    <div className="min-h-screen bg-gray-50 font-sans text-gray-800 pb-12">
      {/* Header Principal */}
      <header className="bg-white shadow-md border-b border-gray-200 sticky top-0 z-30">
        <div className="max-w-6xl mx-auto px-4 h-20 flex items-center justify-between">
          {/* LOGO NTR */}
          <div 
            className="flex items-center gap-4 cursor-pointer group"
            onClick={() => setView('home')}
          >
            <div className={`${ntrBlue} px-3 py-2 rounded shadow-md flex flex-col items-center justify-center select-none group-hover:bg-blue-800 transition-colors`}>
              <span className="font-serif text-3xl font-black text-white leading-none tracking-tighter" style={{ fontFamily: 'Times New Roman, serif' }}>
                NTR
              </span>
              <span className="text-[0.5rem] text-white font-bold tracking-[0.2em] uppercase leading-none mt-1 opacity-90">
                Periodismo Crítico
              </span>
            </div>
            <div className="h-10 w-px bg-gray-300 hidden sm:block"></div>
            <h1 className="text-xl font-bold tracking-tight text-gray-700 hidden sm:block group-hover:text-blue-900 transition-colors">
              Zacatecas
            </h1>
          </div>
          
          {/* Navegación Principal */}
          <nav className="flex items-center gap-2 sm:gap-4">
            <button 
              onClick={() => setView('home')}
              className={`px-4 py-2 rounded-full font-bold text-sm transition-all flex items-center gap-2 ${
                view === 'home' || view === 'article'
                  ? 'bg-gray-100 text-blue-900 ring-2 ring-blue-900/10' 
                  : 'text-gray-500 hover:bg-gray-50'
              }`}
            >
              <Home size={18} /> <span className="hidden sm:inline">Inicio</span>
            </button>
            <button 
              onClick={() => setView('create')}
              className={`px-4 py-2 rounded-full font-bold text-sm transition-all flex items-center gap-2 ${
                view === 'create' 
                  ? `${ntrBlue} text-white shadow-lg transform scale-105` 
                  : 'text-gray-500 hover:bg-gray-50'
              }`}
            >
              <PlusCircle size={18} /> <span className="hidden sm:inline">Redacción</span> <span className="sm:hidden">Crear</span>
            </button>
          </nav>
        </div>
      </header>

      {/* Contenido Principal */}
      <main className="max-w-6xl mx-auto px-4 py-8">
        
        {/* VISTA 1: HOME (FEED) */}
        {view === 'home' && (
          <div className="space-y-6 animate-in fade-in duration-500">
            <div className="flex items-center justify-between border-b border-gray-200 pb-4">
              <h2 className={`text-2xl font-bold ${ntrText}`}>Últimas Noticias</h2>
              <span className="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-xs font-bold">
                {articles.length} al día
              </span>
            </div>

            {articles.length === 0 ? (
              <div className="text-center py-32 bg-white rounded-xl border border-dashed border-gray-300">
                <p className="text-gray-500 text-lg">No hay noticias publicadas hoy.</p>
                <button onClick={() => setView('create')} className={`mt-4 ${ntrText} underline font-medium`}>
                  Ir a Redacción para crear una
                </button>
              </div>
            ) : (
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                {articles.map((article) => (
                  <article 
                    key={article.id} 
                    onClick={() => openArticle(article)}
                    className="bg-white rounded-xl shadow-sm hover:shadow-2xl hover:-translate-y-1 transition-all duration-300 overflow-hidden border border-gray-100 group cursor-pointer flex flex-col h-full"
                  >
                    <div className="relative w-full h-56 overflow-hidden bg-gray-200">
                      <img 
                        src={article.image} 
                        alt={article.title}
                        className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-700"
                        onError={(e) => {
                          e.target.onerror = null; 
                          e.target.src = "https://images.unsplash.com/photo-1504711434969-e33886168f5c?w=800&auto=format&fit=crop&q=60";
                        }}
                      />
                      <div className="absolute top-4 left-4">
                        <span className={`${ntrBlue} text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg uppercase tracking-wide`}>
                          {article.category}
                        </span>
                      </div>
                    </div>

                    <div className="p-6 flex-grow flex flex-col justify-between">
                      <div>
                        <div className="flex items-center text-gray-400 text-xs mb-3 gap-2">
                          <Calendar size={14} />
                          <span>{article.date}</span>
                        </div>
                        <h3 className="text-xl font-bold text-gray-900 mb-3 leading-tight group-hover:text-blue-900 transition-colors line-clamp-3">
                          {article.title}
                        </h3>
                        <p className="text-gray-600 text-sm line-clamp-3 mb-4">
                          {article.content}
                        </p>
                      </div>
                      
                      <div className="pt-4 border-t border-gray-50 flex justify-between items-center mt-auto">
                        <div className="flex items-center gap-4">
                          <span className={`text-sm font-bold ${ntrText} flex items-center`}>
                            Leer nota completa
                          </span>
                          {/* Indicador de comentarios */}
                          <div className="flex items-center text-gray-400 text-xs gap-1">
                            <MessageSquare size={14} />
                            <span>{(article.comments || []).length}</span>
                          </div>
                        </div>

                        <button 
                          onClick={(e) => handleDelete(e, article.id)}
                          className="text-gray-300 hover:text-red-500 transition-colors p-1"
                          title="Eliminar"
                        >
                          <Trash2 size={16} />
                        </button>
                      </div>
                    </div>
                  </article>
                ))}
              </div>
            )}
          </div>
        )}

        {/* VISTA 2: CREAR (REDACCIÓN) */}
        {view === 'create' && (
          <div className="max-w-3xl mx-auto animate-in slide-in-from-bottom-4 duration-500">
            <div className="bg-white rounded-xl shadow-xl p-8 border border-gray-100">
              <div className="border-b border-gray-100 pb-6 mb-6">
                <h2 className={`text-2xl font-bold flex items-center ${ntrText}`}>
                  <PlusCircle className="mr-3" size={28} /> Panel de Redacción
                </h2>
                <p className="text-gray-500 mt-2">Completa los campos para publicar una nueva nota en portada.</p>
              </div>
              
              <form onSubmit={handleSubmit} className="space-y-6">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div className="col-span-1 md:col-span-2">
                    <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Titular de la noticia</label>
                    <input
                      type="text"
                      value={title}
                      onChange={(e) => setTitle(e.target.value)}
                      placeholder="Escribe un título impactante..."
                      className="w-full p-4 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-800 focus:border-blue-800 outline-none transition-all font-bold text-lg text-gray-800 placeholder:font-normal"
                      required
                    />
                  </div>

                  <div>
                    <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Sección</label>
                    <select 
                      value={category}
                      onChange={(e) => setCategory(e.target.value)}
                      className="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg outline-none"
                    >
                      <option>General</option>
                      <option>Tecnología</option>
                      <option>Deportes</option>
                      <option>Arte</option>
                      <option>Política</option>
                      <option>Seguridad</option>
                      <option>Municipios</option>
                    </select>
                  </div>
                </div>

                <div>
                  <label className="block text-xs font-bold text-gray-500 uppercase mb-3">Imagen Principal</label>
                  <div className="p-4 border-2 border-dashed border-gray-200 rounded-xl bg-gray-50 hover:bg-white transition-colors">
                    {!image ? (
                      <div className="space-y-4">
                        <div className="flex justify-center">
                          <label className={`cursor-pointer flex flex-col items-center gap-2 px-6 py-4 rounded-lg hover:bg-blue-50 hover:text-blue-900 text-gray-500 transition-all group`}>
                            <Upload size={32} className="group-hover:scale-110 transition-transform mb-2"/>
                            <span className="font-medium">Subir foto desde dispositivo</span>
                            <input type="file" accept="image/*" onChange={handleImageUpload} className="hidden" />
                          </label>
                        </div>
                        
                        <div className="text-center text-xs text-gray-400 font-medium uppercase tracking-widest">O selecciona una de stock</div>
                        
                        <div className="grid grid-cols-2 sm:grid-cols-4 gap-2">
                          {presetImages.map((preset) => (
                            <button
                              type="button"
                              key={preset.name}
                              onClick={() => setImage(preset.url)}
                              className="text-xs p-2 rounded-lg flex flex-col items-center justify-center gap-2 border bg-white border-gray-200 hover:border-blue-800 hover:text-blue-900 transition-all h-20"
                            >
                              {preset.icon} {preset.name}
                            </button>
                          ))}
                        </div>
                        
                         <input
                          type="text"
                          value={image.startsWith('data:') ? '' : image}
                          onChange={(e) => setImage(e.target.value)}
                          placeholder="O pega una URL externa..."
                          className="w-full text-xs p-2 bg-transparent border-b border-gray-300 focus:border-blue-800 outline-none text-center"
                        />
                      </div>
                    ) : (
                      <div className="relative h-64 w-full rounded-lg overflow-hidden group shadow-lg">
                        <img src={image} alt="Preview" className="w-full h-full object-cover" />
                        <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                          <button 
                            type="button"
                            onClick={() => setImage('')}
                            className="bg-white text-red-600 px-4 py-2 rounded-full font-bold shadow-lg transform hover:scale-105 transition-transform flex items-center gap-2"
                          >
                            <Trash2 size={16} /> Cambiar imagen
                          </button>
                        </div>
                      </div>
                    )}
                  </div>
                </div>

                <div>
                  <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Cuerpo de la noticia</label>
                  <textarea
                    value={content}
                    onChange={(e) => setContent(e.target.value)}
                    placeholder="Desarrolla el contenido de la nota aquí. Puedes usar varios párrafos..."
                    rows="12"
                    className="w-full p-4 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-800 focus:border-blue-800 outline-none resize-none leading-relaxed"
                    required
                  />
                </div>

                <div className="pt-4 flex gap-4">
                  <button 
                    type="button"
                    onClick={() => setView('home')}
                    className="flex-1 py-4 bg-gray-100 text-gray-600 font-bold rounded-lg hover:bg-gray-200 transition-colors"
                  >
                    Cancelar
                  </button>
                  <button 
                    type="submit" 
                    className={`flex-[2] ${ntrBlue} hover:bg-blue-800 text-white font-bold py-4 rounded-lg shadow-lg shadow-blue-900/20 transition-all flex items-center justify-center gap-2 transform active:scale-95`}
                  >
                    <Send size={20} /> Publicar Noticia
                  </button>
                </div>
              </form>
            </div>
          </div>
        )}

        {/* VISTA 3: ARTÍCULO COMPLETO */}
        {view === 'article' && selectedArticle && (
          <div className="max-w-4xl mx-auto bg-white min-h-screen sm:min-h-0 sm:rounded-none sm:shadow-none animate-in fade-in zoom-in-95 duration-300">
            {/* Barra de navegación interna del artículo */}
            <div className="sticky top-16 z-10 bg-white/95 backdrop-blur-md border-b border-gray-100 px-4 py-3 flex items-center justify-between mb-6">
              <button 
                onClick={() => setView('home')}
                className={`flex items-center gap-2 text-sm font-bold ${ntrText} hover:opacity-80 transition-opacity`}
              >
                <ArrowLeft size={20} /> Volver a Noticias
              </button>
              <div className="flex gap-2">
                <span className="text-gray-400 text-xs uppercase tracking-widest font-bold">
                  {selectedArticle.category}
                </span>
              </div>
            </div>

            <article className="px-4 sm:px-0 pb-12">
              <h1 className="text-3xl sm:text-4xl md:text-5xl font-black text-gray-900 leading-tight mb-6 font-serif">
                {selectedArticle.title}
              </h1>

              <div className="flex items-center justify-between border-t border-b border-gray-100 py-4 mb-8">
                <div className="flex items-center gap-3">
                  <div className={`w-10 h-10 rounded-full ${ntrBlue} flex items-center justify-center text-white font-bold font-serif`}>
                    N
                  </div>
                  <div>
                    <div className="text-sm font-bold text-gray-900">{selectedArticle.author || "Redacción NTR"}</div>
                    <div className="text-xs text-gray-500">{selectedArticle.date}</div>
                  </div>
                </div>
                <div className="flex gap-4 items-center">
                  <div className="flex items-center gap-1 text-gray-500 text-sm">
                    <MessageSquare size={16} />
                    <span>{(selectedArticle.comments || []).length} comentarios</span>
                  </div>
                </div>
              </div>

              <div className="relative w-full aspect-video rounded-xl overflow-hidden shadow-xl mb-10">
                <img 
                  src={selectedArticle.image} 
                  alt={selectedArticle.title}
                  className="w-full h-full object-cover"
                />
              </div>

              <div className="prose prose-lg prose-blue max-w-none text-gray-700 leading-loose">
                {selectedArticle.content.split('\n').map((paragraph, idx) => (
                  paragraph.trim() && <p key={idx} className="mb-6">{paragraph}</p>
                ))}
              </div>

              {/* SECCIÓN DE COMENTARIOS */}
              <div className="mt-16 bg-gray-50 rounded-2xl p-6 sm:p-10">
                <h3 className="text-2xl font-bold text-gray-900 mb-8 flex items-center gap-2">
                  <MessageSquare className="text-blue-900" /> Comentarios
                </h3>

                {/* Lista de comentarios existentes */}
                <div className="space-y-6 mb-10">
                  {selectedArticle.comments && selectedArticle.comments.length > 0 ? (
                    selectedArticle.comments.map((comment) => (
                      <div key={comment.id} className="bg-white p-5 rounded-xl border border-gray-100 shadow-sm">
                        <div className="flex items-center justify-between mb-2">
                          <div className="flex items-center gap-2">
                            <div className="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-900">
                              <User size={16} />
                            </div>
                            <span className="font-bold text-gray-900">{comment.author}</span>
                          </div>
                          <span className="text-xs text-gray-400">{comment.date}</span>
                        </div>
                        <p className="text-gray-700 pl-10">{comment.text}</p>
                      </div>
                    ))
                  ) : (
                    <div className="text-center py-6 text-gray-500 italic">
                      No hay comentarios aún. ¡Sé el primero en opinar!
                    </div>
                  )}
                </div>

                {/* Formulario para agregar comentario */}
                <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                  <h4 className="font-bold text-lg mb-4 text-gray-800">Deja tu opinión</h4>
                  <form onSubmit={handleAddComment} className="space-y-4">
                    <div>
                      <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Nombre</label>
                      <input
                        type="text"
                        value={commentName}
                        onChange={(e) => setCommentName(e.target.value)}
                        placeholder="Tu nombre..."
                        className="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-900 outline-none"
                        required
                      />
                    </div>
                    <div>
                      <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Comentario</label>
                      <textarea
                        value={commentText}
                        onChange={(e) => setCommentText(e.target.value)}
                        placeholder="Escribe aquí lo que piensas..."
                        rows="3"
                        className="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-900 outline-none resize-none"
                        required
                      />
                    </div>
                    <div className="flex justify-end">
                      <button 
                        type="submit" 
                        className={`${ntrBlue} hover:bg-blue-800 text-white font-bold py-2 px-6 rounded-lg transition-colors flex items-center gap-2`}
                      >
                        <Send size={16} /> Publicar comentario
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </article>

            {/* Footer del artículo */}
            <div className="border-t-4 border-blue-900 pt-8 pb-12 mt-12 bg-gray-50 -mx-4 sm:mx-0 px-8 text-center rounded-b-xl">
              <h3 className="font-bold text-gray-900 mb-2">¿Te gustó esta nota?</h3>
              <p className="text-gray-500 text-sm mb-6">Sigue leyendo más noticias en NTR Zacatecas</p>
              <button 
                onClick={() => setView('home')}
                className={`inline-flex items-center gap-2 ${ntrBlue} text-white px-6 py-3 rounded-full font-bold hover:opacity-90 transition-opacity`}
              >
                <Home size={18} /> Ir al Inicio
              </button>
            </div>
          </div>
        )}
      </main>
    </div>
  );
}
